{% assign lang = site.locale | slice: 0,2 | default: "en" %}
{% case lang %}
{% when "gr" %}
  {% assign lang = "gr" %}
{% else %}
  {% assign lang = "en" %}
{% endcase %}

<!-- Deferred Lunr search loading for performance -->
<script>
  // Only load search when user interacts with search
  let searchLoaded = false;
  
  function loadSearch() {
    if (searchLoaded) return;
    searchLoaded = true;
    
    // Load Lunr scripts dynamically
    const scripts = [
      '{{ "/assets/js/lunr/lunr.min.js" | relative_url }}',
      '{{ "/assets/js/lunr/lunr-store.js" | relative_url }}',
      '{{ "/assets/js/lunr/lunr-" | append: lang | append: ".js" | relative_url }}'
    ];
    
    // Load scripts in sequence
    let loadIndex = 0;
    function loadNext() {
      if (loadIndex >= scripts.length) return;
      const script = document.createElement('script');
      script.src = scripts[loadIndex];
      script.onload = () => {
        loadIndex++;
        loadNext();
      };
      document.head.appendChild(script);
    }
    loadNext();
  }
  
  // Load search when user focuses on search input or clicks search button
  function attachSearchListeners() {
    const searchInputs = document.querySelectorAll('.search-input, #search-input, #search');
    const searchButtons = document.querySelectorAll('.search__toggle, .search-content__form button');

    searchInputs.forEach(input => {
      if (!input.hasAttribute('data-search-listener')) {
        input.setAttribute('data-search-listener', 'true');
        input.addEventListener('focus', loadSearch, { once: true });
        input.addEventListener('click', loadSearch, { once: true });
      }
    });

    searchButtons.forEach(button => {
      if (!button.hasAttribute('data-search-listener')) {
        button.setAttribute('data-search-listener', 'true');
        button.addEventListener('click', loadSearch, { once: true });
      }
    });
  }

  document.addEventListener('DOMContentLoaded', attachSearchListeners);

  // Also check for dynamically added search elements
  const observer = new MutationObserver(function(mutations) {
    let shouldAttach = false;
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList') {
        mutation.addedNodes.forEach(function(node) {
          if (node.nodeType === 1) { // Element node
            if (node.matches && (node.matches('.search-input') || node.querySelector && node.querySelector('.search-input'))) {
              shouldAttach = true;
            }
          }
        });
      }
    });
    if (shouldAttach) {
      attachSearchListeners();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });
</script>